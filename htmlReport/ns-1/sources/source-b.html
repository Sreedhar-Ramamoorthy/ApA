


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > PaymentServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">ke.co.apollo.health.service.impl</a>
</div>

<h1>Coverage Summary for Class: PaymentServiceImpl (ke.co.apollo.health.service.impl)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">PaymentServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    56%
  </span>
  <span class="absValue">
    (14/25)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/122)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    60%
  </span>
  <span class="absValue">
    (242/403)
  </span>
</td>
</tr>
  <tr>
    <td class="name">PaymentServiceImpl$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$1eNiVYo3</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$2m8T2eCm</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$9wqykOt2</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$a2XYuadb</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$BLgtAaBs</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$e7d3fRip</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$eYIe2omJ</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$ityhdohv</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$JGQj1GMi</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$LNB8O5AG</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$n13eFedx</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$PcdKnQh3</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$QE6kQym2</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$QUuzPAdP</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$s7j2sxqI</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$wXQysBVl</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$Xl8Qe1Kz</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$XLoRRF6e</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$271991126$auxiliary$zKbvXALF</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$0MmcqdBD</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$1S2A8tn8</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$2zLex80E</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$3mgj7oif</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$a482pv56</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$b6fEgaQC</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$c2FhnfDl</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$CAxmhoXL</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$CuSj5Te8</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$dZRVhlbF</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$FNHl0qPT</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$m8egRDyd</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$mB3T7YV7</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$NGMQI1ak</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$oIohZIFI</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$QdTaUwvz</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$QJupMthu</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$Qsw3aaTw</td>
  </tr>
  <tr>
    <td class="name">PaymentServiceImpl$MockitoMock$423185721$auxiliary$Y9DGkhbq</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    53.8%
  </span>
  <span class="absValue">
    (14/26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/122)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    59.9%
  </span>
  <span class="absValue">
    (242/404)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package ke.co.apollo.health.service.impl;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.io.StringWriter;
&nbsp;import java.math.BigDecimal;
&nbsp;import java.util.*;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import com.google.gson.Gson;
&nbsp;import freemarker.template.Configuration;
&nbsp;import freemarker.template.Template;
&nbsp;import freemarker.template.TemplateException;
&nbsp;import ke.co.apollo.health.common.domain.model.*;
&nbsp;import ke.co.apollo.health.common.domain.model.request.*;
&nbsp;import ke.co.apollo.health.common.domain.model.response.InAppNotificationMessageResponse;
&nbsp;import ke.co.apollo.health.common.utils.HealthDateUtils;
&nbsp;import ke.co.apollo.health.domain.entity.HealthStepEntity;
&nbsp;import ke.co.apollo.health.domain.request.MpesaExpressRequest;
&nbsp;import ke.co.apollo.health.domain.response.MainMpesaExpressResponse;
&nbsp;import ke.co.apollo.health.enums.HealthQuoteStepsEnum;
&nbsp;import ke.co.apollo.health.mapper.health.QuoteMapper;
&nbsp;import ke.co.apollo.health.repository.HealthAgentBranchRepository;
&nbsp;import ke.co.apollo.health.repository.HealthStepRepository;
&nbsp;import ke.co.apollo.health.service.*;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;
&nbsp;import org.apache.commons.collections4.CollectionUtils;
&nbsp;import org.apache.commons.lang3.StringUtils;
&nbsp;import org.apache.commons.lang3.time.DateFormatUtils;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.transaction.annotation.Transactional;
&nbsp;
&nbsp;import ke.co.apollo.health.common.constants.GlobalConstant;
&nbsp;import ke.co.apollo.health.common.domain.model.remote.PaymentWalletResponse;
&nbsp;import ke.co.apollo.health.common.domain.model.remote.PolicyNumberRequest;
&nbsp;import ke.co.apollo.health.common.domain.model.response.PaymentHistoryListResponse;
&nbsp;import ke.co.apollo.health.common.domain.model.response.TransactionCreateResponse;
&nbsp;import ke.co.apollo.health.common.domain.model.response.TransactionValidateResponse;
&nbsp;import ke.co.apollo.health.common.enums.PolicyStatus;
&nbsp;import ke.co.apollo.health.common.exception.BusinessException;
&nbsp;import ke.co.apollo.health.config.NotificationMessageBuilder;
&nbsp;import ke.co.apollo.health.domain.request.QuoteBalanceUpdateRequest;
&nbsp;import ke.co.apollo.health.domain.request.TransactionDetailTaskAddRequest;
&nbsp;import ke.co.apollo.health.domain.response.PaymentHistoryResponse;
&nbsp;import ke.co.apollo.health.enums.PaymentMethod;
&nbsp;import ke.co.apollo.health.mapper.health.PaymentHistoryMapper;
&nbsp;import ke.co.apollo.health.mapper.health.PaymentTransactionMapper;
&nbsp;import ke.co.apollo.health.remote.NotificationRemote;
&nbsp;import ke.co.apollo.health.remote.PaymentRemote;
&nbsp;import ke.co.apollo.health.remote.PolicyRemote;
&nbsp;
&nbsp;import static ke.co.apollo.health.common.enums.ProductEnum.JAMIIPLUS_SHARED;
&nbsp;
&nbsp;@Service
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;public class PaymentServiceImpl implements PaymentService {
&nbsp;
&nbsp;  @Autowired
&nbsp;  private PaymentRemote paymentRemote;
&nbsp;
&nbsp;  @Autowired
&nbsp;  private  PolicyRemote policyRemote;
&nbsp;
&nbsp;  @Autowired
&nbsp;  private  NotificationRemote notificationRemote;
&nbsp;
&nbsp;  @Autowired
&nbsp;  private  PaymentHistoryMapper paymentHistoryMapper;
&nbsp;
&nbsp;  @Autowired
&nbsp;  private  PaymentTransactionMapper paymentTransactionMapper;
&nbsp;
&nbsp;  @Autowired
&nbsp;  private  QuoteService quoteService;
&nbsp;
&nbsp;  @Autowired
&nbsp;  private  CustomerService customerService;
&nbsp;
&nbsp;  @Autowired
&nbsp;  private  TransactionDetailService transactionDetailService;
&nbsp;
&nbsp;  @Autowired
&nbsp;  private  NotificationMessageBuilder notificationMessageBuilder;
&nbsp;
&nbsp;  @Autowired
&nbsp;  private  PolicyService policyService;
&nbsp;
&nbsp;  @Autowired
&nbsp;  IntermediaryService intermediaryService;
&nbsp;
&nbsp;  @Autowired
&nbsp;  HealthStepRepository stepRepository;
&nbsp;
&nbsp;  @Autowired
&nbsp;  HealthAgentBranchRepository agentBranchRepository;
&nbsp;
&nbsp;  @Autowired
&nbsp;  QuoteMapper quoteMapper;
&nbsp;
&nbsp;  @Value(&quot;${business.email.recipient.address}&quot;)
&nbsp;  String destinationEmail;
&nbsp;
&nbsp;  private final Configuration configuration;
&nbsp;
&nbsp;  private final Gson g;
&nbsp;
&nbsp;
<b class="fc">&nbsp;  public PaymentServiceImpl(Configuration configuration, Gson gson) {</b>
<b class="fc">&nbsp;    this.configuration = configuration;</b>
<b class="fc">&nbsp;    this.g = gson;</b>
<b class="fc">&nbsp;  }</b>
&nbsp;
&nbsp;  @Override
&nbsp;  @Transactional(&quot;healthDataTransactionManager&quot;)
&nbsp;  public TransactionCreateResponse createPaymentTransaction(PaymentCreateRequest request) {
&nbsp;
<b class="fc">&nbsp;    log.info(&quot;create payment transaction start, PaymentCreateRequest: {}&quot;, g.toJson(request));</b>
&nbsp;
<b class="fc">&nbsp;    String quoteNumber = &quot;&quot;;</b>
&nbsp;    Integer policyId;
&nbsp;    String policyNumber;
&nbsp;    Date effectiveDate;
&nbsp;    String business;
&nbsp;
<b class="fc">&nbsp;    String quoteId = request.getQuoteId();</b>
<b class="fc">&nbsp;    String customerId = request.getCustomerId();</b>
<b class="fc">&nbsp;    Customer customer = customerService.getCustomer(customerId);</b>
<b class="pc">&nbsp;    if (customer == null) {</b>
<b class="fc">&nbsp;      throw new BusinessException(&quot;Can&#39;t find customer [&quot; + customerId + &quot;]&quot;);</b>
&nbsp;    }
<b class="pc">&nbsp;    if (request.isRenewal()) {</b>
<b class="pc">&nbsp;      if (StringUtils.isEmpty(request.getPolicyNumber())) {</b>
<b class="fc">&nbsp;        throw new BusinessException(&quot;Policy Number is mandatory&quot;);</b>
&nbsp;      }
<b class="pc">&nbsp;      if (request.getEffectiveDate() == null) {</b>
<b class="fc">&nbsp;        throw new BusinessException(&quot;Effective Date is mandatory&quot;);</b>
&nbsp;      }
<b class="fc">&nbsp;      policyNumber = request.getPolicyNumber();</b>
<b class="fc">&nbsp;      effectiveDate = request.getEffectiveDate();</b>
<b class="fc">&nbsp;      PolicyDetail policyDetail = policyRemote.getPolicyDetail(</b>
<b class="fc">&nbsp;          PolicyNumberRequest.builder().policyNumber(policyNumber).effectiveDate(effectiveDate)</b>
<b class="fc">&nbsp;              .build());</b>
<b class="pc">&nbsp;      if (policyDetail == null) {</b>
<b class="fc">&nbsp;        throw new BusinessException(</b>
&nbsp;            &quot;Can&#39;t find policy, policyNumber[&quot; + policyNumber + &quot;], effectiveDate[&quot; + effectiveDate + &quot;]&quot;);
&nbsp;      }
&nbsp;
<b class="pc">&nbsp;      if (!(PolicyStatus.LIVE.getValue().equals(policyDetail.getPolicyStatus())||PolicyStatus.LAPSE.getValue().equals(policyDetail.getPolicyStatus()))) {</b>
<b class="fc">&nbsp;        throw new BusinessException(&quot;Policy[&quot; + policyNumber + &quot;] has expired, policyStatus: &quot; + policyDetail.getPolicyStatus());</b>
&nbsp;      }
&nbsp;
<b class="fc">&nbsp;      policyId = policyDetail.getPolicyId();</b>
<b class="fc">&nbsp;      business = &quot;renewal policy&quot;;</b>
<b class="fc">&nbsp;      updateStep(policyNumber, customer.getAgentId(), customerId, HealthQuoteStepsEnum.PAYMENT_DIALOG);</b>
<b class="fc">&nbsp;    } else {</b>
<b class="fc">&nbsp;      updateStep(quoteId, customer.getAgentId(), customerId, HealthQuoteStepsEnum.PAYMENT_DIALOG);</b>
<b class="pc">&nbsp;      if (StringUtils.isEmpty(request.getQuoteId())) {</b>
<b class="fc">&nbsp;        throw new BusinessException(&quot;Quote Id is mandatory&quot;);</b>
&nbsp;      }
&nbsp;      //
<b class="fc">&nbsp;      Quote quote = quoteService.getQuote(quoteId, customerId, null);</b>
<b class="fc">&nbsp;      this.checkQuote(quoteId, quote);</b>
&nbsp;
<b class="nc">&nbsp;      quoteNumber = quote.getCode();</b>
<b class="nc">&nbsp;      policyId = quote.getExtPolicyId();</b>
<b class="nc">&nbsp;      policyNumber = quote.getExtPolicyNumber();</b>
<b class="nc">&nbsp;      effectiveDate = quote.getEffectiveDate();</b>
<b class="nc">&nbsp;      business = &quot;buy new policy&quot;;</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    BigDecimal amount = new BigDecimal(request.getAmount());</b>
<b class="fc">&nbsp;    PaymentTransaction paymentTransaction = PaymentTransaction.builder()</b>
<b class="fc">&nbsp;        .customerId(customerId).status(&quot;New&quot;)</b>
<b class="fc">&nbsp;        .amount(amount).renewal(request.isRenewal())</b>
<b class="fc">&nbsp;        .quoteId(quoteId).quoteNumber(quoteNumber)</b>
<b class="fc">&nbsp;        .policyId(String.valueOf(policyId))</b>
<b class="fc">&nbsp;        .policyNumber(policyNumber).effectiveDate(effectiveDate)</b>
<b class="fc">&nbsp;        .createTime(new Date())</b>
<b class="fc">&nbsp;        .build();</b>
<b class="fc">&nbsp;    paymentTransactionMapper.insert(paymentTransaction);</b>
&nbsp;
<b class="fc">&nbsp;    TransactionCreateRequest transactionCreateRequest = TransactionCreateRequest.builder()</b>
<b class="fc">&nbsp;            .amount(amount).applicationCustomerEmail(customer.getEmail())</b>
<b class="fc">&nbsp;            .applicationPolicyNumber(policyNumber)</b>
<b class="fc">&nbsp;            .applicationCustomerId(customer.getCustomerId())</b>
<b class="fc">&nbsp;            .applicationScene(business)</b>
<b class="fc">&nbsp;            .applicationType(&quot;health&quot;)</b>
<b class="fc">&nbsp;            .build();</b>
<b class="fc">&nbsp;    TransactionCreateResponse response = paymentRemote.createTransaction(transactionCreateRequest);</b>
<b class="fc">&nbsp;    paymentTransaction.setOrderId(response.getOrderId());</b>
<b class="fc">&nbsp;    paymentTransaction.setPaymentCustomerId(response.getCustomerId());</b>
<b class="fc">&nbsp;    paymentTransaction.setMerchantId(response.getMerchantId());</b>
<b class="fc">&nbsp;    paymentTransaction.setTerminalId(response.getTerminalId());</b>
<b class="fc">&nbsp;    paymentTransaction.setCurrency(response.getCurrency());</b>
<b class="fc">&nbsp;    paymentTransaction.setDomain(response.getDomain());</b>
<b class="fc">&nbsp;    paymentTransaction.setPreauth(response.getPreauth());</b>
<b class="fc">&nbsp;    paymentTransaction.setTransactionRef(response.getTransactionRef());</b>
<b class="fc">&nbsp;    paymentTransaction.setUpdateTime(new Date());</b>
<b class="fc">&nbsp;    paymentTransactionMapper.updateByPrimaryKey(paymentTransaction);</b>
<b class="fc">&nbsp;    return response;</b>
&nbsp;  }
&nbsp;
&nbsp;  public void updateStep(String quoteOrPolicy, String agentId, String customerId, HealthQuoteStepsEnum step){
<b class="fc">&nbsp;    log.info(&quot;\n ==== created step {} : for quote/policy {} ==== \n &quot; , step, quoteOrPolicy);</b>
<b class="fc">&nbsp;    stepRepository.save(HealthStepEntity</b>
<b class="fc">&nbsp;            .builder()</b>
<b class="fc">&nbsp;            .quoteOrPolicyId(quoteOrPolicy)</b>
<b class="fc">&nbsp;            .agentId(agentId)</b>
<b class="fc">&nbsp;            .customerId(customerId)</b>
<b class="fc">&nbsp;            .step(step)</b>
<b class="fc">&nbsp;            .build());</b>
<b class="nc">&nbsp;  }</b>
&nbsp;
&nbsp;  private void checkQuote(String quoteId, Quote quote) {
<b class="pc">&nbsp;    if (quote == null) {</b>
<b class="fc">&nbsp;      throw new BusinessException(</b>
&nbsp;          &quot;Can&#39;t find quote[&quot; + quoteId + &quot;]&quot;);
&nbsp;    }
&nbsp;
<b class="pc">&nbsp;    if (PolicyStatus.NEW.getValue().equals(quote.getStatus()) || PolicyStatus.VIEWED.getValue()</b>
<b class="pc">&nbsp;        .equals(quote.getStatus())) {</b>
<b class="fc">&nbsp;      throw new BusinessException(</b>
&nbsp;          &quot; Quote[&quot; + quoteId + &quot;] is in process, can&#39;t create payment transaction&quot;);
&nbsp;    }
<b class="nc">&nbsp;    if (StringUtils.isBlank(quote.getExtPolicyNumber()) || quote.getEffectiveDate() == null) {</b>
<b class="nc">&nbsp;      throw new BusinessException(</b>
&nbsp;          &quot; Can&#39;t find policy number for quote[&quot; + quoteId + &quot;]&quot;);
&nbsp;    }
<b class="nc">&nbsp;  }</b>
&nbsp;
&nbsp;  @Override
&nbsp;  public TransactionValidateResponse validatePaymentTransaction(PaymentValidateRequest request) throws TemplateException, IOException {
<b class="fc">&nbsp;    log.info(&quot;\n\n===== PAYMENT VALIDATION =====&quot;);</b>
<b class="fc">&nbsp;    log.info(&quot;\n validate payment transaction start, Validation Payload : {}&quot;, new Gson().toJson(request));</b>
<b class="fc">&nbsp;    PaymentTransaction transaction = paymentTransactionMapper.select(request.getCustomerId(), request.getOrderId(), request.getTransactionRef());</b>
<b class="pc">&nbsp;    if (transaction == null) {</b>
<b class="fc">&nbsp;      throw new BusinessException(&quot;Can&#39;t find the transaction [customerId:&quot; + request.getCustomerId() + &quot;, orderId:&quot; + request.getOrderId() + &quot;, transactionRef:&quot; + request.getTransactionRef() + &quot;]&quot;);</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    log.info(&quot;ORDER ID ::: {}&quot;, transaction.getOrderId());</b>
<b class="fc">&nbsp;    log.info(&quot;REQUEST ORDER ID ::: {}&quot;, request.getOrderId());</b>
<b class="fc">&nbsp;    log.info(&quot;CUSTOMER ID :::: {}&quot;, transaction.getCustomerId());</b>
<b class="fc">&nbsp;    log.info(&quot;MPESA ACCOUNT REF :::: {}&quot;, request.getMpesaAccountReference());</b>
<b class="fc">&nbsp;    log.info(&quot;MPESA CONFIRMATION CODE :::: {}&quot;, request.getMpesaRefOrCheckoutId());</b>
<b class="fc">&nbsp;    log.info(&quot;TRANSACTION REF :::: {}&quot;, request.getTransactionRef());</b>
&nbsp;
<b class="fc">&nbsp;    TransactionValidateRequest transactionValidateRequest = TransactionValidateRequest.builder()</b>
<b class="fc">&nbsp;            .applicationType(&quot;health&quot;)</b>
<b class="fc">&nbsp;            .message(request.getMessage())</b>
<b class="fc">&nbsp;            .orderId(request.getOrderId())</b>
<b class="fc">&nbsp;            .mpesaRefOrCheckoutId(request.getMpesaRefOrCheckoutId())</b>
<b class="fc">&nbsp;            .transactionRef(request.getTransactionRef())</b>
<b class="fc">&nbsp;            .paymentMethod(request.getPaymentMethod())</b>
<b class="fc">&nbsp;            .paymentResponse(request.getPaymentResponse())</b>
<b class="fc">&nbsp;            .success(request.isSuccess())</b>
<b class="fc">&nbsp;            .resultExternalReference(request.getExternalReference())</b>
<b class="fc">&nbsp;            .mpesaAccountReference(request.getMpesaAccountReference())</b>
<b class="fc">&nbsp;            .build();</b>
<b class="fc">&nbsp;    TransactionValidateResponse response = paymentRemote.validateTransaction(transactionValidateRequest);</b>
<b class="pc">&nbsp;    String status = response.isSuccess() ? GlobalConstant.PAYMENT_SUCCESS : GlobalConstant.PAYMENT_FAILED;</b>
<b class="fc">&nbsp;    String msg = response.getMessage();</b>
<b class="pc">&nbsp;    if (StringUtils.isNotBlank(msg) &amp;&amp; msg.length() &gt; 1000) {</b>
<b class="nc">&nbsp;      msg = msg.substring(0, 1000);</b>
&nbsp;    }
&nbsp;
<b class="fc">&nbsp;    transaction.setStatus(status);</b>
<b class="fc">&nbsp;    transaction.setPaymentMethod(request.getPaymentMethod());</b>
<b class="fc">&nbsp;    transaction.setPaymentMessage(msg);</b>
<b class="fc">&nbsp;    transaction.setClientResult(request.isSuccess());</b>
<b class="fc">&nbsp;    transaction.setClientMessage(request.getMessage());</b>
<b class="fc">&nbsp;    transaction.setUpdateTime(new Date());</b>
&nbsp;
<b class="fc">&nbsp;    log.info(&quot;\n\n===== PAYMENT VALIDATION STATUS =====&quot;);</b>
<b class="fc">&nbsp;    log.info(&quot;MESSAGE ::: {}&quot;, response.getMessage());</b>
<b class="fc">&nbsp;    log.info(&quot;STATUS :::: {}&quot;, status);</b>
<b class="fc">&nbsp;    paymentTransactionMapper.update(transaction);</b>
<b class="fc">&nbsp;    String inAppMessage = notificationMessageBuilder.getMessage(&quot;INAPP_NOTIFICATION_MESSAGE_PAID_POLICY&quot;, transaction.getPolicyNumber());</b>
<b class="pc">&nbsp;    if (response.isSuccess()) {</b>
<b class="fc">&nbsp;      sendPaymentNotification(transaction);</b>
<b class="pc">&nbsp;      if(transaction.getQuoteId()!=null) {</b>
<b class="fc">&nbsp;        updateQuoteStartDate(transaction.getCustomerId(), transaction.getQuoteId());</b>
&nbsp;      }
<b class="fc">&nbsp;      sendPaymentInAppNotification(transaction, inAppMessage);</b>
&nbsp;      try{
<b class="fc">&nbsp;        this.updateBalance(transaction);</b>
<b class="nc">&nbsp;      }catch (Exception e){</b>
<b class="nc">&nbsp;        log.info(&quot;\n\n ==== Failed to do Update for balances before validation ==== {}&quot;, e.getMessage());</b>
<b class="fc">&nbsp;      }</b>
<b class="fc">&nbsp;      log.warn(&quot;Update transaction with {} : &quot;, transaction);</b>
&nbsp;    }
<b class="fc">&nbsp;    log.debug(&quot;validate payment transaction end&quot;);</b>
<b class="fc">&nbsp;    return response;</b>
&nbsp;  }
&nbsp;
&nbsp;  public void sendPaymentNotification(PaymentTransaction transaction) throws IOException, TemplateException {
<b class="fc">&nbsp;    log.warn(&quot;Sending notification  {} &quot;, transaction);</b>
<b class="fc">&nbsp;    String customerId = transaction.getCustomerId();</b>
<b class="fc">&nbsp;    Customer customer  = customerService.getCustomer(customerId);</b>
<b class="fc">&nbsp;    List&lt;Customer&gt; dependants = customerService.getCustomerByParentId(customerId);</b>
<b class="fc">&nbsp;    StringWriter stringWriter = new StringWriter();</b>
<b class="fc">&nbsp;    Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;    model.put(&quot;holderName&quot;, customer.getFirstName().toUpperCase() + &quot; &quot; +customer.getLastName().toUpperCase()  );</b>
<b class="pc">&nbsp;    model.put(&quot;holderId&quot;, StringUtils.isNotBlank(customer.getIdNo())?customer.getIdNo():&quot;N/A&quot;);</b>
<b class="fc">&nbsp;    model.put(&quot;holderPhoneNumber&quot;, customer.getPhoneNumber());</b>
<b class="fc">&nbsp;    model.put(&quot;holderEmail&quot;, customer.getEmail());</b>
<b class="fc">&nbsp;    model.put(&quot;holderGender&quot;, customer.getGender().toUpperCase());</b>
<b class="fc">&nbsp;    model.put(&quot;dependants&quot;, dependants);</b>
<b class="fc">&nbsp;    model.put(&quot;policyNumber&quot;, transaction.getPolicyNumber());</b>
<b class="fc">&nbsp;    model.put(&quot;username&quot;, &quot;Apollo Group&quot;);</b>
<b class="fc">&nbsp;    model.put(&quot;premium&quot;, transaction.getAmount());</b>
<b class="fc">&nbsp;    model.put(&quot;benefit&quot;, customer.getBenefit());</b>
<b class="fc">&nbsp;    String travel = &quot;NO&quot;;</b>
<b class="pc">&nbsp;    if(transaction.isRenewal()){</b>
<b class="fc">&nbsp;      HealthPolicy policy = policyService.getPolicy(transaction.getPolicyNumber(),transaction.getEffectiveDate());</b>
<b class="fc">&nbsp;      model.put(&quot;benefitValues&quot;, policy.getBenefit());</b>
<b class="pc">&nbsp;      if(policy.getBenefit().getTravelInsurance() != null  &amp;&amp; policy.getBenefit().getTravelInsurance() &gt; 0) {</b>
<b class="fc">&nbsp;        travel = &quot;YES&quot;;</b>
&nbsp;      }
<b class="fc">&nbsp;      model.put(&quot;productType&quot;, &quot;&quot;);</b>
<b class="fc">&nbsp;    }else{</b>
<b class="fc">&nbsp;      Quote quote = quoteService.getQuoteByPolicyNumber(customerId, transaction.getPolicyNumber());</b>
<b class="fc">&nbsp;      model.put(&quot;benefitValues&quot;, quote.getBenefit());</b>
<b class="pc">&nbsp;      if(quote.getBenefit().getTravelInsurance() != null &amp;&amp; quote.getBenefit().getTravelInsurance() &gt; 0) {</b>
<b class="fc">&nbsp;        travel = &quot;YES&quot;;</b>
&nbsp;      }
<b class="fc">&nbsp;      model.put(&quot;productType&quot;, getProductTypeDescription(quote));</b>
&nbsp;    }
<b class="fc">&nbsp;    model.put(&quot;travel&quot;, travel);</b>
<b class="pc">&nbsp;    if(customer.getAgentId() != null) {</b>
<b class="fc">&nbsp;      Intermediary intermediary = intermediaryService.getIntermediary(customer.getAgentId());</b>
<b class="fc">&nbsp;      model.put(&quot;agentName&quot;, intermediary.getFirstName().toUpperCase()  + &quot; &quot; + intermediary.getLastName().toUpperCase() );</b>
<b class="fc">&nbsp;      model.put(&quot;agentEmail&quot;, intermediary.getEmail());</b>
<b class="fc">&nbsp;      model.put(&quot;agentPhoneNumber&quot;, intermediary.getPhoneNumber());</b>
<b class="fc">&nbsp;      model.put(&quot;agentStatus&quot;, intermediary.getStatus());</b>
<b class="fc">&nbsp;      model.put(&quot;isAgent&quot;, 1);</b>
<b class="fc">&nbsp;      model.put(&quot;agentBranch&quot;, intermediary.getBranchName().toUpperCase() );</b>
<b class="fc">&nbsp;    }else{</b>
<b class="fc">&nbsp;      model.put(&quot;isAgent&quot;, 0);</b>
&nbsp;    }
&nbsp;
&nbsp;
<b class="pc">&nbsp;    if(configuration != null) {</b>
&nbsp;
<b class="fc">&nbsp;      Template temp = configuration.getTemplate(&quot;business_notification_email_template.ftlh&quot;);</b>
&nbsp;
<b class="pc">&nbsp;      if(null != temp){</b>
<b class="fc">&nbsp;        temp.process(model, stringWriter);</b>
<b class="fc">&nbsp;        String template = stringWriter.getBuffer().toString();</b>
<b class="fc">&nbsp;        EmailAttachmentRequest req = new EmailAttachmentRequest();</b>
<b class="fc">&nbsp;        req.setEmailAddress(destinationEmail);</b>
<b class="fc">&nbsp;        req.setSubject(&quot;New Business - &quot; + transaction.getPolicyNumber());</b>
&nbsp;
<b class="pc">&nbsp;        if(transaction.isRenewal())</b>
<b class="fc">&nbsp;          req.setSubject(&quot;Renewal Business - &quot; + transaction.getPolicyNumber());</b>
&nbsp;
<b class="fc">&nbsp;        req.setText(template);</b>
<b class="fc">&nbsp;        req.setAttachmentPath(&quot;&quot;);</b>
<b class="fc">&nbsp;        req.setAttachmentName(&quot;No_Attachment&quot;);</b>
<b class="fc">&nbsp;        log.warn(&quot;Email Request  {} &quot;, req);</b>
<b class="fc">&nbsp;        notificationRemote.sendEmailWithTemplate(req);</b>
&nbsp;      }
&nbsp;    }
<b class="fc">&nbsp;    log.warn(&quot;Sending notification end {} &quot;, model);</b>
<b class="nc">&nbsp;  }</b>
&nbsp;  public String getProductTypeDescription(Quote quote){
<b class="pc">&nbsp;    if(quote.getProductId().equals(JAMIIPLUS_SHARED.getId())){</b>
<b class="fc">&nbsp;      return &quot;Family Shared&quot;;</b>
&nbsp;    }
<b class="fc">&nbsp;    return &quot;Individual&quot;;</b>
&nbsp;  }
&nbsp;
&nbsp;  private void updateBalance(PaymentTransaction transaction) {
<b class="fc">&nbsp;    log.debug(&quot;update balance start&quot;);</b>
<b class="fc">&nbsp;    boolean result = false;</b>
<b class="fc">&nbsp;    String msg = &quot;&quot;;</b>
&nbsp;    try {
<b class="pc">&nbsp;      if (transaction.isRenewal()) {</b>
<b class="fc">&nbsp;        result = policyService</b>
<b class="fc">&nbsp;            .updatePolicyRenewalBalance(transaction.getPolicyNumber(),</b>
<b class="fc">&nbsp;                transaction.getEffectiveDate(),</b>
<b class="fc">&nbsp;                transaction.getAmount());</b>
&nbsp;      } else {
<b class="fc">&nbsp;        result = quoteService.updateQuoteBalance(</b>
<b class="fc">&nbsp;            QuoteBalanceUpdateRequest.builder().quoteId(transaction.getQuoteId())</b>
<b class="fc">&nbsp;                .customerId(transaction.getCustomerId())</b>
<b class="fc">&nbsp;                .paidAmount(transaction.getAmount())</b>
<b class="fc">&nbsp;                .build());</b>
&nbsp;      }
<b class="nc">&nbsp;    } catch (Exception e) {</b>
<b class="nc">&nbsp;      msg = e.getMessage();</b>
<b class="nc">&nbsp;      log.error(&quot;update balance exception: {}&quot;, msg);</b>
<b class="nc">&nbsp;      if (StringUtils.isNotBlank(msg) &amp;&amp; msg.length() &gt; 1000) {</b>
<b class="nc">&nbsp;        msg = msg.substring(0, 1000);</b>
&nbsp;      }
<b class="fc">&nbsp;    }</b>
&nbsp;
<b class="fc">&nbsp;    transaction.setBalanceResult(result);</b>
<b class="fc">&nbsp;    transaction.setBalanceMessage(msg);</b>
<b class="fc">&nbsp;    transaction.setUpdateTime(new Date());</b>
<b class="pc">&nbsp;    result = paymentTransactionMapper.update(transaction) == 1;</b>
<b class="fc">&nbsp;    log.debug(&quot;update balance end {}&quot;, result);</b>
<b class="nc">&nbsp;  }</b>
&nbsp;
&nbsp;  @Override
&nbsp;  public List&lt;PaymentTransaction&gt; getTransactionListByPolicyNumber(PolicyNumberRequest request) {
<b class="nc">&nbsp;    return paymentTransactionMapper</b>
<b class="nc">&nbsp;        .selectList(request.getPolicyNumber(), request.getEffectiveDate());</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  @Transactional(&quot;healthDataTransactionManager&quot;)
&nbsp;  public Boolean paymentRequest(PaymentRequest request) {
<b class="nc">&nbsp;    boolean result = false;</b>
<b class="nc">&nbsp;    PaymentHistory paymentHistory = null;</b>
<b class="nc">&nbsp;    if (request.getRenewal().booleanValue()) {</b>
<b class="nc">&nbsp;      if (StringUtils.isEmpty(request.getPolicyNumber())) {</b>
<b class="nc">&nbsp;        throw new BusinessException(&quot;Policy Number is mandatory&quot;);</b>
&nbsp;      }
<b class="nc">&nbsp;      if (request.getEffectiveDate() == null) {</b>
<b class="nc">&nbsp;        throw new BusinessException(&quot;Effective Date is mandatory&quot;);</b>
&nbsp;      }
<b class="nc">&nbsp;      if (StringUtils.isEmpty(request.getPremium())) {</b>
<b class="nc">&nbsp;        throw new BusinessException(&quot;Premium is mandatory&quot;);</b>
&nbsp;      }
<b class="nc">&nbsp;      paymentHistory = PaymentHistory.builder()</b>
<b class="nc">&nbsp;          .paymentPhone(request.getPaymentPhoneNumber())</b>
<b class="nc">&nbsp;          .paymentType(request.getPaymentMethods()).amount(request.getAmount())</b>
<b class="nc">&nbsp;          .premium(request.getPremium()).renewal(request.getRenewal().booleanValue())</b>
<b class="nc">&nbsp;          .policyNumber(request.getPolicyNumber()).effectiveDate(request.getEffectiveDate())</b>
<b class="nc">&nbsp;          .customerId(request.getCustomerId()).build();</b>
<b class="nc">&nbsp;      paymentHistoryMapper.addPaymentHistoryRenewal(paymentHistory);</b>
&nbsp;    } else {
<b class="nc">&nbsp;      Quote quote = quoteService.getQuote(request.getQuoteId(), request.getCustomerId(), null);</b>
<b class="nc">&nbsp;      if (quote != null) {</b>
<b class="nc">&nbsp;        request.setPolicyNumber(quote.getExtPolicyNumber());</b>
<b class="nc">&nbsp;        paymentHistory = PaymentHistory.builder()</b>
<b class="nc">&nbsp;            .paymentPhone(request.getPaymentPhoneNumber())</b>
<b class="nc">&nbsp;            .paymentType(request.getPaymentMethods()).amount(request.getAmount())</b>
<b class="nc">&nbsp;            .premium(quote.getPremium().getTotalPremium().toPlainString())</b>
<b class="nc">&nbsp;            .renewal(request.getRenewal().booleanValue())</b>
<b class="nc">&nbsp;            .quoteNumber(request.getQuoteId())</b>
<b class="nc">&nbsp;            .customerId(request.getCustomerId()).build();</b>
<b class="nc">&nbsp;        paymentHistoryMapper.addPaymentHistory(paymentHistory);</b>
&nbsp;      } else {
<b class="nc">&nbsp;        throw new BusinessException(</b>
<b class="nc">&nbsp;            &quot;Client[&quot; + request.getCustomerId() + &quot;] doesn&#39;t has quote[&quot; + request.getQuoteId()</b>
&nbsp;                + &quot;]&quot;);
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    MpesaExpressRequest re = MpesaExpressRequest.builder()</b>
<b class="nc">&nbsp;            .accountReference(request.getPolicyNumber())</b>
<b class="nc">&nbsp;            .customerPhoneNumber(request.getPaymentPhoneNumber())</b>
<b class="nc">&nbsp;            .description(request.getPolicyNumber())</b>
<b class="nc">&nbsp;            .payableAmount(Double.parseDouble(request.getAmount()))</b>
<b class="nc">&nbsp;            .transactionType(&quot;PAYMENT&quot;)</b>
<b class="nc">&nbsp;            .serviceType(GlobalConstant.HEALTH_SERVICE_TYPE)</b>
<b class="nc">&nbsp;            .build();</b>
<b class="nc">&nbsp;    switch (PaymentMethod.getPaymentMethod(request.getPaymentMethods())) {</b>
&nbsp;      case MPESA:
<b class="nc">&nbsp;        result = processMpesa(re, paymentHistory);</b>
<b class="nc">&nbsp;        break;</b>
&nbsp;      case BANKTRANSFER:
<b class="nc">&nbsp;        result = processBankTransfer(request);</b>
<b class="nc">&nbsp;        break;</b>
&nbsp;      default:
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  public boolean processBankTransfer(PaymentRequest request) {
&nbsp;    boolean result;
<b class="nc">&nbsp;    result = notificationRemote</b>
<b class="nc">&nbsp;        .sendSMSMessage(</b>
<b class="nc">&nbsp;            SMSMessageRequest.builder().from(GlobalConstant.APOLLO_GROUP)</b>
<b class="nc">&nbsp;                .to(request.getPaymentPhoneNumber())</b>
<b class="nc">&nbsp;                .text(notificationMessageBuilder.getMessage(&quot;SMS_MESSAGE_BANK_TRANSFER&quot;))</b>
<b class="nc">&nbsp;                .serviceType(GlobalConstant.HEALTH_SERVICE_TYPE).build());</b>
&nbsp;    //Due to we can not trace bank transfer response,therefore we assume bank transfer succeed and update balance directly after send SMS
<b class="nc">&nbsp;    if (request.getRenewal().booleanValue()) {</b>
<b class="nc">&nbsp;      policyService</b>
<b class="nc">&nbsp;          .updatePolicyRenewalBalance(request.getPolicyNumber(), request.getEffectiveDate(),</b>
<b class="nc">&nbsp;              new BigDecimal(request.getAmount()));</b>
&nbsp;    } else {
<b class="nc">&nbsp;      quoteService.updateQuoteBalance(</b>
<b class="nc">&nbsp;          QuoteBalanceUpdateRequest.builder().quoteId(request.getQuoteId())</b>
<b class="nc">&nbsp;              .customerId(request.getCustomerId())</b>
<b class="nc">&nbsp;              .paidAmount(new BigDecimal(request.getAmount()))</b>
<b class="nc">&nbsp;              .build());</b>
&nbsp;    }
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  public boolean processMpesa(MpesaExpressRequest request,
&nbsp;      PaymentHistory paymentHistory) {
<b class="nc">&nbsp;    boolean result = false;</b>
<b class="nc">&nbsp;    PaymentWalletResponse response = paymentRemote.paymentWalletRequest(request);</b>
<b class="nc">&nbsp;    if (response != null) {</b>
<b class="nc">&nbsp;      if (0 == response.getResponseCode()) {</b>
<b class="nc">&nbsp;        result = true;</b>
<b class="nc">&nbsp;        transactionDetailService.createTransactionDetailTask(</b>
<b class="nc">&nbsp;            TransactionDetailTaskAddRequest.builder()</b>
<b class="nc">&nbsp;                .checkoutRequestId(response.getCheckoutRequestId())</b>
<b class="nc">&nbsp;                .scheduleTime(</b>
<b class="nc">&nbsp;                    new Date(System.currentTimeMillis() + 60 * 60 * 1000))</b>
<b class="nc">&nbsp;                .build());</b>
&nbsp;      }
<b class="nc">&nbsp;      paymentHistoryMapper.appendMpesaResponse(</b>
<b class="nc">&nbsp;          PaymentHistory.builder().id(paymentHistory.getId())</b>
<b class="nc">&nbsp;              .merchantRequestId(response.getMerchantRequestId())</b>
<b class="nc">&nbsp;              .checkoutRequestId(response.getCheckoutRequestId())</b>
<b class="nc">&nbsp;              .customerMsg(response.getCustomerMessage())</b>
<b class="nc">&nbsp;              .responseCode(String.valueOf(response.getResponseCode()))</b>
<b class="nc">&nbsp;              .responseDesc(response.getResponseDescription()).build());</b>
&nbsp;    }
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public PaymentHistory selectPHByCheckoutRequestId(PaymentHistory paymentHistory) {
<b class="nc">&nbsp;    List&lt;PaymentHistory&gt; paymentHistories = paymentHistoryMapper</b>
<b class="nc">&nbsp;        .selectByCheckoutRequestId(paymentHistory);</b>
<b class="nc">&nbsp;    PaymentHistory result = null;</b>
<b class="nc">&nbsp;    if (CollectionUtils.isNotEmpty(paymentHistories)) {</b>
<b class="nc">&nbsp;      result = paymentHistories.get(0);</b>
&nbsp;    }
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public List&lt;PaymentHistoryListResponse&gt; selectPHByPolicyId(String policyId) {
&nbsp;
<b class="nc">&nbsp;    List&lt;PaymentHistoryListResponse&gt; result = null;</b>
<b class="nc">&nbsp;    List&lt;PaymentHistory&gt; paymentHistories = paymentHistoryMapper.selectByPolicyId(policyId);</b>
<b class="nc">&nbsp;    if (CollectionUtils.isNotEmpty(paymentHistories)) {</b>
<b class="nc">&nbsp;      result = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;      BigDecimal balance = null;</b>
<b class="nc">&nbsp;      calculateBalance(result, paymentHistories, balance);</b>
<b class="nc">&nbsp;      result.sort((t1, t2) -&gt; {</b>
<b class="nc">&nbsp;        if (t1.getCreateTime().getTime() == t2.getCreateTime().getTime()) {</b>
<b class="nc">&nbsp;          return 0;</b>
<b class="nc">&nbsp;        } else if (t1.getCreateTime().getTime() &gt; (t2.getCreateTime().getTime())) {</b>
<b class="nc">&nbsp;          return 1;</b>
&nbsp;        } else {
<b class="nc">&nbsp;          return -1;</b>
&nbsp;        }
&nbsp;      });
&nbsp;
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    return result;</b>
&nbsp;  }
&nbsp;
&nbsp;  private void calculateBalance(List&lt;PaymentHistoryListResponse&gt; result,
&nbsp;      List&lt;PaymentHistory&gt; paymentHistories, BigDecimal balance) {
&nbsp;    String status;
&nbsp;    PaymentHistory ph;
<b class="nc">&nbsp;    for (int i = 0; i &lt; paymentHistories.size(); i++) {</b>
<b class="nc">&nbsp;      status = GlobalConstant.PAYMENT_FAILED;</b>
<b class="nc">&nbsp;      ph = paymentHistories.get(i);</b>
<b class="nc">&nbsp;      if (i == 0) {</b>
<b class="nc">&nbsp;        balance = new BigDecimal(ph.getBalance());</b>
&nbsp;      }
<b class="nc">&nbsp;      switch (PaymentMethod.getPaymentMethod(ph.getPaymentType())) {</b>
&nbsp;        case MPESA:
<b class="nc">&nbsp;          if (&quot;0&quot;.equals(ph.getResponseCode())) {</b>
<b class="nc">&nbsp;            if (i &gt; 0) {</b>
<b class="nc">&nbsp;              balance = balance.add(new BigDecimal(ph.getAmount()));</b>
&nbsp;            }
<b class="nc">&nbsp;            status = GlobalConstant.PAYMENT_SUCCESS;</b>
&nbsp;          }
&nbsp;          break;
&nbsp;        case BANKTRANSFER:
<b class="nc">&nbsp;          if (i &gt; 0) {</b>
<b class="nc">&nbsp;            balance = balance.add(new BigDecimal(ph.getAmount()));</b>
&nbsp;          }
<b class="nc">&nbsp;          status = GlobalConstant.PAYMENT_SUCCESS;</b>
<b class="nc">&nbsp;          break;</b>
&nbsp;        default:
&nbsp;          break;
&nbsp;      }
<b class="nc">&nbsp;      PaymentHistoryListResponse phResponse = PaymentHistoryListResponse.builder()</b>
<b class="nc">&nbsp;          .amount(ph.getAmount()).responseCode(ph.getResponseCode()).balance(balance)</b>
<b class="nc">&nbsp;          .paymentType(ph.getPaymentType()).premium(new BigDecimal(ph.getPremium()))</b>
<b class="nc">&nbsp;          .status(status).createTime(ph.getCreateTime()).updateTime(ph.getUpdateTime())</b>
<b class="nc">&nbsp;          .paymentDate(DateFormatUtils.format(ph.getCreateTime(), GlobalConstant.YYYYMMDD_HHMMSS))</b>
<b class="nc">&nbsp;          .build();</b>
<b class="nc">&nbsp;      result.add(phResponse);</b>
&nbsp;    }
<b class="nc">&nbsp;  }</b>
&nbsp;
&nbsp;  @Override
&nbsp;  public List&lt;PaymentHistoryResponse&gt; getPaymentTransactionList(String customerId,
&nbsp;      String policyNumber) {
<b class="nc">&nbsp;    List&lt;PaymentHistoryResponse&gt; responseList = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    List&lt;PaymentTransaction&gt; paymentTransactionList = paymentTransactionMapper</b>
<b class="nc">&nbsp;        .selectByCustomerIdAndPolicyNumber(customerId, policyNumber, &quot;Success&quot;);</b>
<b class="nc">&nbsp;    if (CollectionUtils.isNotEmpty(paymentTransactionList)) {</b>
<b class="nc">&nbsp;      paymentTransactionList.stream().forEach(t -&gt; {</b>
<b class="nc">&nbsp;        PaymentHistoryResponse response = PaymentHistoryResponse.builder().date(t.getUpdateTime())</b>
<b class="nc">&nbsp;            .premium(t.getAmount()).paymentMethod(t.getPaymentMethod())</b>
<b class="nc">&nbsp;            .transactionRef(t.getTransactionRef()).build();</b>
<b class="nc">&nbsp;        responseList.add(response);</b>
<b class="nc">&nbsp;      });</b>
&nbsp;    }
<b class="nc">&nbsp;    return responseList;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public MainMpesaExpressResponse requestStk(MpesaExpressRequest request) {
<b class="nc">&nbsp;    log.info(&quot;Health M-pesa request : {}&quot;, request);</b>
<b class="nc">&nbsp;    PaymentWalletResponse paymentWalletResponse = paymentRemote.paymentWalletRequest(request);</b>
<b class="nc">&nbsp;    return MainMpesaExpressResponse.builder()</b>
<b class="nc">&nbsp;            .data(paymentWalletResponse)</b>
<b class="nc">&nbsp;            .success(true)</b>
<b class="nc">&nbsp;            .msg(paymentWalletResponse.getResponseDescription())</b>
<b class="nc">&nbsp;            .build();</b>
&nbsp;  }
&nbsp;
&nbsp;  public void updateQuoteStartDate(String customerId, String quoteId){
<b class="fc">&nbsp;    Quote quote = quoteMapper.getQuote(quoteId, customerId, null);</b>
<b class="pc">&nbsp;    if(quote != null) {</b>
<b class="fc">&nbsp;      quote.setStartDate(new Date());</b>
<b class="fc">&nbsp;      quote.setEffectiveDate(new Date());</b>
<b class="fc">&nbsp;      quote.setRenewalDate(HealthDateUtils.nextYear(new Date()));</b>
<b class="fc">&nbsp;      quote.setUpdateTime(new Date());</b>
<b class="fc">&nbsp;      quoteMapper.update(quote);</b>
&nbsp;    }
<b class="nc">&nbsp;  }</b>
&nbsp;
&nbsp;  public void sendPaymentInAppNotification(PaymentTransaction transaction, String message) {
<b class="fc">&nbsp;    Customer customer  = customerService.getCustomer(transaction.getCustomerId());</b>
<b class="pc">&nbsp;    if(customer != null) {</b>
<b class="fc">&nbsp;      notificationRemote.createInAppNotification(</b>
<b class="fc">&nbsp;              InAppNotificationCreateRequest.builder()</b>
<b class="fc">&nbsp;                      .notification(message)</b>
<b class="fc">&nbsp;                      .readStatus(GlobalConstant.READ_STATUS)</b>
<b class="fc">&nbsp;                      .phoneNumber(customer.getPhoneNumber())</b>
<b class="fc">&nbsp;                      .email(customer.getEmail())</b>
<b class="fc">&nbsp;                      .serviceType(GlobalConstant.HEALTH_SERVICE_TYPE)</b>
<b class="fc">&nbsp;                      .actionStatus(GlobalConstant.HEALTH_PAYMENT_NOTIFICATION_STATUS)</b>
<b class="fc">&nbsp;                      .notificationSubject(GlobalConstant.HEALTH_PAYMENT_NOTIFICATION_THANK_TITLE)</b>
<b class="fc">&nbsp;                      .policyNumber(transaction.getPolicyNumber())</b>
<b class="fc">&nbsp;                      .build());</b>
<b class="fc">&nbsp;      clearRenewalInAppNotification(customer.getPhoneNumber(), transaction.getPolicyNumber());</b>
&nbsp;    }
<b class="nc">&nbsp;  }</b>
&nbsp;
&nbsp;  public void clearRenewalInAppNotification(String phoneNumber, String policyNumber) {
<b class="fc">&nbsp;    log.info(&quot;clearRenewalInAppNotification: {}&quot;, phoneNumber);</b>
<b class="fc">&nbsp;    List&lt;InAppNotificationMessageResponse&gt; responseList = notificationRemote.getAllInAppNotificationList(</b>
<b class="fc">&nbsp;            InAppNotificationMessageRequest.builder()</b>
<b class="fc">&nbsp;                    .pageSize(100)</b>
<b class="fc">&nbsp;                    .pageNumber(0)</b>
<b class="fc">&nbsp;                    .phoneNumber(phoneNumber)</b>
<b class="fc">&nbsp;                    .build());</b>
<b class="fc">&nbsp;    List&lt;Integer&gt; ids = responseList.stream()</b>
<b class="fc">&nbsp;            .filter(response -&gt;</b>
<b class="pc">&nbsp;                    response.getPolicyNumber() != null &amp;&amp; response.getPolicyNumber().equals(policyNumber) &amp;&amp;</b>
<b class="pc">&nbsp;                            response.getActionStatus() != null &amp;&amp; response.getActionStatus().equals(GlobalConstant.HEALTH_RENEWAL_NOTIFICATION_STATUS))</b>
<b class="fc">&nbsp;            .map(InAppNotificationMessageResponse::getId)</b>
<b class="fc">&nbsp;            .map(Integer::parseInt)</b>
<b class="fc">&nbsp;            .collect(Collectors.toList());</b>
<b class="fc">&nbsp;    log.info(&quot;clearRenewalInAppNotification ids : {}&quot;, ids);</b>
<b class="fc">&nbsp;    boolean result = notificationRemote.clearInAppNotification(ids);</b>
<b class="fc">&nbsp;    log.info(&quot;clearRenewalInAppNotification Result : {}&quot;, result);</b>
<b class="nc">&nbsp;  }</b>
&nbsp;  public HashMap&lt;String, String&gt; createCreditCardPaymentRequest(CreditCardTransactionRequest request) {
<b class="fc">&nbsp;    return paymentRemote.createCreditCardPaymentRequest(request);</b>
&nbsp;  }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-03-08 11:50</div>
</div>
</body>
</html>
